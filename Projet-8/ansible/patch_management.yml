---
# ============================================
# Playbook : patch_management.yml
# Description : Gestion des mises √† jour Windows et Linux
# Auteur : Cl√©ment
# Date : Janvier 2026
# Version : 1.0 - Patch Management Unifi√©
# ============================================

- name: üîÑ Gestion des mises √† jour sur le parc Barzini
  hosts: barzini
  gather_facts: yes
  
  vars:
    # Logs
    log_dir_linux: "/var/log/ansible"
    log_dir_windows: "C:\\Logs\\Ansible"
  
  tasks:
    # ==========================================
    # SECTION GLOBALE : Informations
    # ==========================================
    
    - name: "[GLOBAL] Affichage des informations syst√®me"
      debug:
        msg:
          - "=========================================="
          - "üîÑ PATCH MANAGEMENT BARZINI"
          - "=========================================="
          - "Host : {{ inventory_hostname }}"
          - "OS Family : {{ ansible_os_family }}"
          - "Distribution : {{ ansible_distribution | default('Windows') }}"
          - "Version : {{ ansible_distribution_version | default(ansible_os_name) }}"
          - "=========================================="
      tags: [always]
    
    # ==========================================
    # SECTION LINUX : Mises √† jour APT
    # ==========================================
    
    - name: "üìã [LINUX] Gestion des mises √† jour"
      become: yes
      block:
        - name: "[LINUX] Cr√©ation du r√©pertoire de logs"
          file:
            path: "{{ log_dir_linux }}"
            state: directory
            mode: '0755'
        
        - name: "[LINUX] Mise √† jour du cache APT"
          apt:
            update_cache: yes
            cache_valid_time: 3600
          register: apt_update
        
        - name: "[LINUX] Liste des paquets √† mettre √† jour"
          shell: apt list --upgradable 2>/dev/null | grep -v "Listing" | wc -l
          register: packages_upgradable
          changed_when: false
        
        - name: "[LINUX] Affichage du nombre de mises √† jour disponibles"
          debug:
            msg: "{{ packages_upgradable.stdout }} paquet(s) √† mettre √† jour"
        
        - name: "[LINUX] Installation des mises √† jour"
          apt:
            upgrade: dist
            autoremove: yes
            autoclean: yes
          register: apt_upgrade
          when: packages_upgradable.stdout|int > 0
        
        - name: "[LINUX] V√©rification si red√©marrage n√©cessaire"
          stat:
            path: /var/run/reboot-required
          register: reboot_required_file
        
        - name: "[LINUX] Red√©marrage si n√©cessaire"
          reboot:
            msg: "Red√©marrage pour appliquer les mises √† jour"
            reboot_timeout: 300
          when: reboot_required_file.stat.exists
          register: linux_reboot
        
        - name: "[LINUX] Rapport des mises √† jour"
          debug:
            msg:
              - "--- Rapport Linux ---"
              - "Mises √† jour disponibles : {{ packages_upgradable.stdout }}"
              - "Statut : {{ 'Mises √† jour install√©es ‚úÖ' if apt_upgrade.changed else 'Syst√®me √† jour ‚ÑπÔ∏è' }}"
              - "Red√©marrage : {{ 'Effectu√© ‚úÖ' if linux_reboot.changed | default(false) else 'Non n√©cessaire ‚ÑπÔ∏è' }}"
      
      when: ansible_os_family != "Windows"
      tags: [linux, updates]
    
    # ==========================================
    # SECTION WINDOWS : Mises √† jour Windows Update
    # ==========================================
    
    - name: "üìã [WINDOWS] Gestion des mises √† jour"
      block:
        - name: "[WINDOWS] Cr√©ation du r√©pertoire de logs"
          win_file:
            path: "{{ log_dir_windows }}"
            state: directory
        
        - name: "[WINDOWS] Recherche des mises √† jour disponibles"
          win_updates:
            category_names:
              - CriticalUpdates
              - SecurityUpdates
              - UpdateRollups
              - Updates
            state: searched
          register: windows_updates_available
        
        - name: "[WINDOWS] Affichage du nombre de mises √† jour disponibles"
          debug:
            msg: "{{ windows_updates_available.found_update_count }} mise(s) √† jour disponible(s)"
        
        - name: "[WINDOWS] Installation des mises √† jour"
          win_updates:
            category_names:
              - CriticalUpdates
              - SecurityUpdates
              - UpdateRollups
              - Updates
            state: installed
            reboot: yes
            reboot_timeout: 3600
          register: windows_updates_result
          async: 7200
          poll: 60
          when: windows_updates_available.found_update_count > 0
        
        - name: "[WINDOWS] Rapport des mises √† jour"
          debug:
            msg:
              - "--- Rapport Windows ---"
              - "Mises √† jour disponibles : {{ windows_updates_available.found_update_count }}"
              - "Mises √† jour install√©es : {{ windows_updates_result.installed_update_count | default(0) }}"
              - "Mises √† jour √©chou√©es : {{ windows_updates_result.failed_update_count | default(0) }}"
              - "Red√©marrage : {{ 'Effectu√© ‚úÖ' if windows_updates_result.rebooted | default(false) else 'Non n√©cessaire ‚ÑπÔ∏è' }}"
              - "Statut : {{ '‚úÖ SUCC√àS' if windows_updates_result.failed_update_count | default(0) == 0 else '‚ö†Ô∏è AVEC ERREURS' }}"
      
      when: ansible_os_family == "Windows"
      tags: [windows, updates]
    
    # ==========================================
    # SECTION FINALE : R√©capitulatif
    # ==========================================
    
    - name: "üéâ [FINAL] R√©capitulatif du patch management"
      debug:
        msg:
          - "=========================================="
          - "‚úÖ PATCH MANAGEMENT TERMIN√â"
          - "=========================================="
          - "Host : {{ inventory_hostname }}"
          - "OS : {{ ansible_os_family }}"
          - "Statut : ‚úÖ SUCC√àS"
          - "=========================================="
      tags: [always, report]

# ============================================
# NOTES D'UTILISATION
# ============================================
#
# D√âPLOIEMENT COMPLET (Windows + Linux) :
#   kinit Administrateur@BARZINI.BA
#   ansible-playbook -i /etc/ansible/inventories/hosts \
#       patch_management.yml -K
#
# D√âPLOIEMENT WINDOWS UNIQUEMENT :
#   kinit Administrateur@BARZINI.BA
#   ansible-playbook -i /etc/ansible/inventories/hosts \
#       patch_management.yml --limit windows
#
# D√âPLOIEMENT LINUX UNIQUEMENT :
#   ansible-playbook -i /etc/ansible/inventories/hosts \
#       patch_management.yml --limit linux -K
#
# IMPORTANT :
# - Les mises √† jour Windows peuvent prendre 1-2 heures
# - Le syst√®me peut red√©marrer automatiquement
# - Pr√©voir une fen√™tre de maintenance
#
# ============================================
