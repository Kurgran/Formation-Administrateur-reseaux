# Infrastructure IT Entreprise (AD, GLPI, Ansible)

**Description courte** : Infrastructure complÃ¨te d'entreprise avec Active Directory, gestion de parc GLPI et automatisation Ansible pour un environnement hybride Windows/Linux
**Contexte homelab** : DÃ©ployÃ© sur Proxmox (4 VMs dÃ©diÃ©es)
**Date** : FÃ©vrier 2026

---

## ğŸ“‹ Vue d'ensemble

Projet d'infrastructure IT complÃ¨te simulant la gestion d'un parc de 40+ utilisateurs pour une entreprise fictive de dÃ©veloppement de jeux vidÃ©o. L'infrastructure intÃ¨gre Active Directory pour la gestion centralisÃ©e des identitÃ©s, GLPI pour l'inventaire du parc matÃ©riel, et Ansible pour l'automatisation des dÃ©ploiements et configurations.

Ce projet dÃ©montre la capacitÃ© Ã  concevoir, dÃ©ployer et maintenir une infrastructure d'entreprise hybride Windows/Linux en appliquant les bonnes pratiques de sÃ©curitÃ© (mÃ©thodologie AGDLP, authentification Kerberos, automatisation des tÃ¢ches rÃ©currentes).

**Composants principaux :**
- **Active Directory (Windows Server 2022)** : Annuaire centralisÃ©, DNS, DHCP, GPO
- **GLPI (Linux Debian)** : Gestion du parc matÃ©riel/logiciel, synchronisation LDAP avec AD
- **Ansible** : Automatisation du montage de partages rÃ©seau, dÃ©ploiement d'outils, patch management

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RÃ©seau 192.168.10.0/24                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Windows Server  â”‚        â”‚  Linux Server    â”‚           â”‚
â”‚  â”‚    (DC-01)       â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  (SRV-GLPI)      â”‚           â”‚
â”‚  â”‚                  â”‚  LDAP  â”‚                  â”‚           â”‚
â”‚  â”‚  - AD DS         â”‚        â”‚  - GLPI          â”‚           â”‚
â”‚  â”‚  - DNS           â”‚        â”‚  - Ansible       â”‚           â”‚
â”‚  â”‚  - DHCP          â”‚        â”‚  - Apache        â”‚           â”‚
â”‚  â”‚  - File Server   â”‚        â”‚  - MariaDB       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ Kerberos Auth                                    â”‚
â”‚           â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚                                           â”‚               â”‚
â”‚  â–¼                                           â–¼               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Client       â”‚                   â”‚ Client       â”‚         â”‚
â”‚ â”‚ Windows 11   â”‚                   â”‚ Linux Ubuntu â”‚         â”‚
â”‚ â”‚              â”‚                   â”‚              â”‚         â”‚
â”‚ â”‚ - Auto mount â”‚                   â”‚ - Auto mount â”‚         â”‚
â”‚ â”‚ - GPO apply  â”‚                   â”‚ - Kerberos   â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Infrastructure :**
- **Plateforme** : Proxmox VE 8.x
- **VMs dÃ©ployÃ©es** :
  - `DC-01` : Windows Server 2022 (4 vCPU, 8 Go RAM, 100 Go)
  - `SRV-GLPI` : Debian 12 (2 vCPU, 4 Go RAM, 60 Go)
  - `WIN-CLIENT` : Windows 11 Pro (2 vCPU, 4 Go RAM, 60 Go)
  - `LIN-CLIENT` : Ubuntu 24.04 LTS (2 vCPU, 4 Go RAM, 40 Go)
- **RÃ©seau** : VLAN 10 (192.168.10.0/24)
  - DC-01 : 192.168.10.10
  - SRV-GLPI : 192.168.10.20
- **Stockage** : Sauvegarde quotidienne sur NAS (PBS ou NFS)

---

## âš™ï¸ PrÃ©requis

**Versions testÃ©es :**
- Windows Server 2022 Standard (Desktop Experience)
- Debian 12 (Bookworm)
- GLPI 10.0.x
- Ansible 2.15+
- Python 3.11+ (pour Ansible)

**DÃ©pendances systÃ¨me (Linux) :**
```bash
# Sur SRV-GLPI (Debian)
sudo apt update
sudo apt install -y apache2 mariadb-server php php-{mysql,curl,gd,intl,ldap,apcu,xmlrpc,cas,zip,bz2,mbstring,xml}
sudo apt install -y ansible python3-pip krb5-user sssd sssd-tools
```

**AccÃ¨s rÃ©seau requis :**
- **Port 53 (TCP/UDP)** : DNS
- **Port 88 (TCP/UDP)** : Kerberos
- **Port 389 (TCP)** : LDAP
- **Port 445 (TCP)** : SMB/CIFS (partages rÃ©seau)
- **Port 3389 (TCP)** : RDP (administration)
- **Port 80/443 (TCP)** : GLPI Web Interface

---

## ğŸš€ Installation

### Ã‰tape 1 : DÃ©ploiement Active Directory (Windows Server)

**1.1 Installation du rÃ´le AD DS**
```powershell
# Installer le rÃ´le Active Directory
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools

# Promouvoir le serveur en contrÃ´leur de domaine
Install-ADDSForest `
    -DomainName "vertex.local" `
    -DomainNetbiosName "VERTEX" `
    -ForestMode "WinThreshold" `
    -DomainMode "WinThreshold" `
    -InstallDns:$true `
    -SafeModeAdministratorPassword (ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force) `
    -Force:$true
```

**Explication** : Cette commande installe Active Directory Domain Services et crÃ©e un nouveau domaine `vertex.local`. L'option `-InstallDns:$true` installe automatiquement le rÃ´le DNS intÃ©grÃ© Ã  AD, essentiel pour Kerberos.

**1.2 Configuration DNS**
```powershell
# VÃ©rifier que la zone DNS est crÃ©Ã©e
Get-DnsServerZone

# Configurer le serveur pour utiliser lui-mÃªme comme DNS primaire
Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses ("127.0.0.1", "192.168.10.10")
```

**1.3 Installation DHCP (optionnel)**
```powershell
Install-WindowsFeature -Name DHCP -IncludeManagementTools
Add-DhcpServerv4Scope -Name "VLAN10" -StartRange 192.168.10.100 -EndRange 192.168.10.200 -SubnetMask 255.255.255.0
Set-DhcpServerv4OptionValue -ScopeId 192.168.10.0 -DnsServer 192.168.10.10 -Router 192.168.10.1
```

### Ã‰tape 2 : CrÃ©ation de la structure organisationnelle

**2.1 CrÃ©ation des OUs (Organizational Units)**
```powershell
# Script PowerShell pour crÃ©er la structure OU
$BaseDN = "DC=vertex,DC=local"

# CrÃ©er les OUs dÃ©partements
$Departments = @("Direction", "Developpement", "Graphisme", "Audio", "Testing", "IT")

foreach ($Dept in $Departments) {
    New-ADOrganizationalUnit -Name $Dept -Path $BaseDN -ProtectedFromAccidentalDeletion $true
}

# CrÃ©er les sous-OUs pour utilisateurs et groupes
foreach ($Dept in $Departments) {
    New-ADOrganizationalUnit -Name "Users" -Path "OU=$Dept,$BaseDN" -ProtectedFromAccidentalDeletion $true
    New-ADOrganizationalUnit -Name "Groups" -Path "OU=$Dept,$BaseDN" -ProtectedFromAccidentalDeletion $true
}
```

**2.2 CrÃ©ation des utilisateurs (exemple)**
```powershell
# Exemple : crÃ©er un utilisateur dans le dÃ©partement DÃ©veloppement
$SecurePassword = ConvertTo-SecureString "TempPass2024!" -AsPlainText -Force

New-ADUser `
    -Name "Jean Martin" `
    -GivenName "Jean" `
    -Surname "Martin" `
    -SamAccountName "jmartin" `
    -UserPrincipalName "jmartin@vertex.local" `
    -Path "OU=Users,OU=Developpement,DC=vertex,DC=local" `
    -AccountPassword $SecurePassword `
    -Enabled $true `
    -ChangePasswordAtLogon $true
```

**2.3 Application de la mÃ©thodologie AGDLP**
```powershell
# CrÃ©er un groupe GLOBAL pour les dÃ©veloppeurs
New-ADGroup `
    -Name "GG_Developpeurs" `
    -GroupScope Global `
    -Path "OU=Groups,OU=Developpement,DC=vertex,DC=local"

# CrÃ©er un groupe DOMAIN LOCAL pour l'accÃ¨s au partage Dev
New-ADGroup `
    -Name "DL_Acces_Partage_Dev" `
    -GroupScope DomainLocal `
    -Path "OU=Groups,OU=Developpement,DC=vertex,DC=local"

# Ajouter l'utilisateur au groupe global
Add-ADGroupMember -Identity "GG_Developpeurs" -Members "jmartin"

# Donner les permissions au groupe domain local
# (Ã€ faire via l'interface ou icacls sur le partage rÃ©seau)
```

**Points d'attention :**
- **AGDLP** : Toujours suivre Accounts â†’ Global groups â†’ Domain Local groups â†’ Permissions
- **Mots de passe** : Utiliser une politique de complexitÃ© forte en production
- **DNS** : S'assurer que le serveur DNS pointe bien sur lui-mÃªme (127.0.0.1 ou IP du DC)

### Ã‰tape 3 : Configuration des partages rÃ©seau

**3.1 CrÃ©ation du partage rÃ©seau**
```powershell
# CrÃ©er le rÃ©pertoire de partage
New-Item -Path "D:\Partages\Developpement" -ItemType Directory

# CrÃ©er le partage SMB
New-SmbShare -Name "Developpement" -Path "D:\Partages\Developpement" -FullAccess "VERTEX\DL_Acces_Partage_Dev"

# Configurer les permissions NTFS (important !)
icacls "D:\Partages\Developpement" /grant "VERTEX\DL_Acces_Partage_Dev:(OI)(CI)M"
```

**3.2 Enregistrement des SPNs (Service Principal Names)**
```powershell
# CRUCIAL pour Kerberos : enregistrer les SPNs sur le compte machine du serveur de fichiers
setspn -A CIFS/dc-01.vertex.local DC-01$
setspn -A CIFS/dc-01 DC-01$

# VÃ©rifier l'enregistrement
setspn -L DC-01$
```

**Explication** : Les SPNs permettent Ã  Kerberos d'authentifier le service de partage de fichiers (CIFS). Sans SPNs correctement enregistrÃ©s, les clients recevront l'erreur "Server not found in Kerberos database".

### Ã‰tape 4 : DÃ©ploiement GLPI (Linux)

**4.1 Installation de GLPI**
```bash
# TÃ©lÃ©charger GLPI
cd /tmp
wget https://github.com/glpi-project/glpi/releases/download/10.0.12/glpi-10.0.12.tgz
tar -xzf glpi-10.0.12.tgz
sudo mv glpi /var/www/html/

# Configurer les permissions
sudo chown -R www-data:www-data /var/www/html/glpi
sudo chmod -R 755 /var/www/html/glpi
```

**4.2 Configuration Apache**
```bash
sudo tee /etc/apache2/sites-available/glpi.conf <<EOF
<VirtualHost *:80>
    ServerName glpi.vertex.local
    DocumentRoot /var/www/html/glpi

    <Directory /var/www/html/glpi>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/glpi_error.log
    CustomLog \${APACHE_LOG_DIR}/glpi_access.log combined
</VirtualHost>
EOF

# Activer le site et les modules nÃ©cessaires
sudo a2ensite glpi
sudo a2enmod rewrite
sudo systemctl restart apache2
```

**4.3 Configuration de la base de donnÃ©es MariaDB**
```bash
# SÃ©curiser MariaDB
sudo mysql_secure_installation

# CrÃ©er la base GLPI
sudo mysql -u root -p <<EOF
CREATE DATABASE glpi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'glpi_user'@'localhost' IDENTIFIED BY 'SecurePassword123!';
GRANT ALL PRIVILEGES ON glpi.* TO 'glpi_user'@'localhost';
FLUSH PRIVILEGES;
EOF
```

**4.4 Configuration LDAP dans GLPI**

Se connecter Ã  GLPI (`http://192.168.10.20/glpi`) et configurer l'authentification LDAP :

- **Serveur** : `192.168.10.10` (DC-01)
- **Port** : `389`
- **BaseDN** : `DC=vertex,DC=local`
- **Filtre de connexion** : `(&(objectClass=user)(objectCategory=person)(sAMAccountName=*))`
- **Compte de liaison** : `cn=glpi-ldap,cn=Users,dc=vertex,dc=local`
- **Mot de passe** : [mot de passe du compte de service]

**Points d'attention :**
- CrÃ©er un compte de service dÃ©diÃ© dans AD avec des permissions de lecture LDAP uniquement
- Tester la connexion LDAP avant d'activer la synchronisation automatique

### Ã‰tape 5 : DÃ©ploiement Ansible (automatisation)

**5.1 Installation Ansible**
```bash
# Sur SRV-GLPI
sudo apt install -y ansible python3-pip python3-winrm

# Installer les modules Python pour Windows
pip3 install pywinrm[credssp]
```

**5.2 Configuration de l'inventaire Ansible**
```bash
sudo mkdir -p /etc/ansible
sudo tee /etc/ansible/hosts <<EOF
[windows_clients]
win-client ansible_host=192.168.10.50

[linux_clients]
lin-client ansible_host=192.168.10.51

[windows_clients:vars]
ansible_user=administrator@vertex.local
ansible_password=AdminPass123!
ansible_connection=winrm
ansible_winrm_transport=kerberos
ansible_winrm_server_cert_validation=ignore

[linux_clients:vars]
ansible_user=root
ansible_ssh_private_key_file=/root/.ssh/id_rsa
EOF
```

**5.3 Configuration Kerberos pour Ansible**
```bash
sudo tee /etc/krb5.conf <<EOF
[libdefaults]
    default_realm = VERTEX.LOCAL
    dns_lookup_realm = false
    dns_lookup_kdc = true
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    VERTEX.LOCAL = {
        kdc = 192.168.10.10
        admin_server = 192.168.10.10
    }

[domain_realm]
    .vertex.local = VERTEX.LOCAL
    vertex.local = VERTEX.LOCAL
EOF
```

**Explication** : Cette configuration permet Ã  Ansible d'utiliser Kerberos pour s'authentifier auprÃ¨s des clients Windows sans stocker de mots de passe en clair.

---

## ğŸ”§ Configuration

### Fichiers de configuration principaux

**Playbook Ansible : Montage automatique des partages rÃ©seau (Windows)**  
`/etc/ansible/playbooks/mount-network-drives.yml`

```yaml
---
- name: Montage automatique des partages rÃ©seau sur clients Windows
  hosts: windows_clients
  gather_facts: no
  tasks:
    - name: CrÃ©er une tÃ¢che planifiÃ©e pour monter les lecteurs rÃ©seau
      win_scheduled_task:
        name: "Mount Network Drives"
        description: "Monte les partages rÃ©seau en fonction du groupe AD de l'utilisateur"
        actions:
          - path: powershell.exe
            arguments: >-
              -ExecutionPolicy Bypass
              -File "C:\Scripts\Mount-Drives.ps1"
        triggers:
          - type: logon
        username: SYSTEM
        logon_type: interactive_token  # CRUCIAL : utilise le token de l'utilisateur connectÃ©
        run_level: highest
        state: present
        enabled: yes

    - name: DÃ©ployer le script PowerShell de montage
      win_copy:
        src: files/Mount-Drives.ps1
        dest: C:\Scripts\Mount-Drives.ps1
```

**Script PowerShell : Montage des lecteurs rÃ©seau**  
`/etc/ansible/playbooks/files/Mount-Drives.ps1`

```powershell
# Script de montage automatique des partages rÃ©seau
# BasÃ© sur l'appartenance aux groupes AD de l'utilisateur

param()

# Fonction de logging
function Write-Log {
    param([string]$Message)
    $LogPath = "C:\Scripts\Logs\mount-drives.log"
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$Timestamp - $Message" | Out-File -FilePath $LogPath -Append
}

Write-Log "Script de montage des partages dÃ©marrÃ©"

# VÃ©rifier si l'utilisateur est un compte de domaine
$CurrentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
if ($CurrentUser -notlike "VERTEX\*") {
    Write-Log "Utilisateur local dÃ©tectÃ© ($CurrentUser), pas de montage"
    exit 0
}

Write-Log "Utilisateur domaine dÃ©tectÃ© : $CurrentUser"

# Fonction pour monter un lecteur rÃ©seau
function Mount-NetworkDrive {
    param(
        [string]$DriveLetter,
        [string]$SharePath,
        [string]$Label
    )
    
    try {
        # VÃ©rifier si le lecteur est dÃ©jÃ  montÃ©
        if (Test-Path "${DriveLetter}:") {
            Write-Log "Lecteur ${DriveLetter}: dÃ©jÃ  montÃ©, dÃ©montage..."
            net use "${DriveLetter}:" /delete /yes 2>&1 | Out-Null
        }
        
        # Monter le lecteur
        $null = New-PSDrive -Name $DriveLetter -PSProvider FileSystem -Root $SharePath -Persist -Scope Global -ErrorAction Stop
        Write-Log "Lecteur ${DriveLetter}: ($Label) montÃ© avec succÃ¨s : $SharePath"
        return $true
    }
    catch {
        Write-Log "ERREUR lors du montage de ${DriveLetter}: - $($_.Exception.Message)"
        return $false
    }
}

# RÃ©cupÃ©rer les groupes AD de l'utilisateur
try {
    $UserGroups = ([ADSISEARCHER]"(samAccountName=$($env:USERNAME))").FindOne().Properties.memberof
}
catch {
    Write-Log "ERREUR : Impossible de rÃ©cupÃ©rer les groupes AD - $($_.Exception.Message)"
    exit 1
}

# Montage selon les groupes
if ($UserGroups -match "GG_Developpeurs") {
    Mount-NetworkDrive -DriveLetter "D" -SharePath "\\dc-01.vertex.local\Developpement" -Label "DÃ©veloppement"
    Mount-NetworkDrive -DriveLetter "P" -SharePath "\\dc-01.vertex.local\Projets" -Label "Projets"
}

if ($UserGroups -match "GG_Direction") {
    Mount-NetworkDrive -DriveLetter "R" -SharePath "\\dc-01.vertex.local\Direction" -Label "Direction"
}

# Montage du lecteur commun pour tous
Mount-NetworkDrive -DriveLetter "C" -SharePath "\\dc-01.vertex.local\Commun" -Label "Commun"

Write-Log "Script de montage terminÃ©"
```

**Points d'attention critiques :**
- **`logon_type: interactive_token`** : ESSENTIEL pour que le script s'exÃ©cute avec le token Kerberos de l'utilisateur rÃ©el et non en SYSTEM
- **Gestion des conflits de lettres** : DÃ©monter le lecteur existant avant de remonter
- **Logs dÃ©taillÃ©s** : Facilite le debug en cas de problÃ¨me

### Variables d'environnement

| Variable | Valeur | Description |
|----------|--------|-------------|
| `ANSIBLE_HOST_KEY_CHECKING` | `False` | DÃ©sactive la vÃ©rification des clÃ©s SSH (dev uniquement) |
| `KRB5_CONFIG` | `/etc/krb5.conf` | Chemin vers la config Kerberos |
| `GLPI_DB_HOST` | `localhost` | HÃ´te de la base de donnÃ©es GLPI |
| `GLPI_DB_NAME` | `glpi` | Nom de la base de donnÃ©es GLPI |
| `GLPI_DB_USER` | `glpi_user` | Utilisateur DB GLPI |

---

## ğŸ“Š Utilisation

### AccÃ¨s

- **Active Directory** : RDP sur `192.168.10.10` (administrator@vertex.local)
- **GLPI Interface Web** : `http://192.168.10.20/glpi`
  - Login par dÃ©faut (premiÃ¨re installation) : `glpi` / `glpi`
  - AprÃ¨s config LDAP : utilisateurs du domaine AD

### Commandes utiles

**Active Directory (PowerShell)**
```powershell
# VÃ©rifier le statut du contrÃ´leur de domaine
Get-ADDomainController

# Lister tous les utilisateurs
Get-ADUser -Filter * | Select-Object Name, SamAccountName, Enabled

# Forcer la rÃ©plication AD
repadmin /syncall /AdeP

# VÃ©rifier les SPNs d'un compte
setspn -L DC-01$

# Consulter les Ã©vÃ©nements Kerberos
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4768 -or $_.Id -eq 4769} | Select-Object -First 10
```

**GLPI (Linux)**
```bash
# VÃ©rifier le statut d'Apache
sudo systemctl status apache2

# Consulter les logs GLPI
sudo tail -f /var/www/html/glpi/files/_log/php-errors.log

# Tester la connexion LDAP manuellement
ldapsearch -x -H ldap://192.168.10.10 -D "cn=glpi-ldap,cn=Users,dc=vertex,dc=local" -W -b "dc=vertex,dc=local" "(objectClass=user)"
```

**Ansible**
```bash
# Tester la connectivitÃ© aux clients Windows
ansible windows_clients -m win_ping

# Tester la connectivitÃ© aux clients Linux
ansible linux_clients -m ping

# ExÃ©cuter le playbook de montage de partages
ansible-playbook /etc/ansible/playbooks/mount-network-drives.yml

# Mode verbose pour debug
ansible-playbook /etc/ansible/playbooks/mount-network-drives.yml -vvv
```

### Cas d'usage

**Ajouter un nouveau utilisateur et lui donner accÃ¨s au partage DÃ©veloppement**
```powershell
# 1. CrÃ©er l'utilisateur dans AD
$SecurePassword = ConvertTo-SecureString "TempPass2024!" -AsPlainText -Force
New-ADUser -Name "Sophie Durand" -SamAccountName "sdurand" -UserPrincipalName "sdurand@vertex.local" -Path "OU=Users,OU=Developpement,DC=vertex,DC=local" -AccountPassword $SecurePassword -Enabled $true

# 2. Ajouter l'utilisateur au groupe GG_Developpeurs
Add-ADGroupMember -Identity "GG_Developpeurs" -Members "sdurand"

# 3. Le montage automatique se fera lors de la prochaine connexion (via tÃ¢che planifiÃ©e)
```

**DÃ©ployer un patch de sÃ©curitÃ© sur tous les clients Windows**
```bash
# CrÃ©er un playbook pour les mises Ã  jour Windows
ansible-playbook /etc/ansible/playbooks/windows-updates.yml
```

---

## ğŸ› Troubleshooting

### Erreur : "Server not found in Kerberos database"

**Cause** : Les SPNs (Service Principal Names) ne sont pas enregistrÃ©s dans Active Directory pour le service de partage de fichiers.

**Solution** :
```powershell
# Sur le contrÃ´leur de domaine, enregistrer les SPNs
setspn -A CIFS/dc-01.vertex.local DC-01$
setspn -A CIFS/dc-01 DC-01$

# VÃ©rifier l'enregistrement
setspn -L DC-01$

# Forcer la rÃ©plication AD pour propager les changements
repadmin /syncall /AdeP
```

### Erreur : Les partages rÃ©seau ne se montant pas automatiquement

**Cause** : La tÃ¢che planifiÃ©e Windows s'exÃ©cute en contexte SYSTEM au lieu d'utiliser le token de l'utilisateur connectÃ©.

**Solution** :
```powershell
# VÃ©rifier le type de logon de la tÃ¢che planifiÃ©e
Get-ScheduledTask -TaskName "Mount Network Drives" | Select-Object -ExpandProperty Principal

# Si LogonType n'est pas "InteractiveToken", recrÃ©er la tÃ¢che
Unregister-ScheduledTask -TaskName "Mount Network Drives" -Confirm:$false

# CrÃ©er avec le bon logon type via Ansible ou manuellement :
# - Ouvrir Task Scheduler
# - CrÃ©er une tÃ¢che qui se dÃ©clenche "At log on"
# - Dans Security options : "Run only when user is logged on"
# - Cocher "Run with highest privileges"
```

### Erreur : GLPI ne synchronise pas les utilisateurs LDAP

**Cause** : Le compte de service GLPI n'a pas les permissions de lecture sur les OUs Active Directory.

**Solution** :
```powershell
# Sur le contrÃ´leur de domaine, donner les permissions de lecture LDAP au compte glpi-ldap
# Via PowerShell (nÃ©cessite le module ActiveDirectory)

$Account = "VERTEX\glpi-ldap"
$OUs = @(
    "OU=Direction,DC=vertex,DC=local",
    "OU=Developpement,DC=vertex,DC=local",
    "OU=Graphisme,DC=vertex,DC=local"
    # ... autres OUs
)

foreach ($OU in $OUs) {
    $ACL = Get-Acl -Path "AD:$OU"
    $Rule = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(
        (New-Object System.Security.Principal.NTAccount($Account)),
        [System.DirectoryServices.ActiveDirectoryRights]::GenericRead,
        [System.Security.AccessControl.AccessControlType]::Allow
    )
    $ACL.AddAccessRule($Rule)
    Set-Acl -Path "AD:$OU" -AclObject $ACL
}
```

### Erreur : Ansible ne peut pas se connecter aux clients Windows

**Cause** : WinRM n'est pas configurÃ© ou Kerberos ne fonctionne pas correctement.

**Solution** :
```bash
# Sur le serveur Ansible, vÃ©rifier la configuration Kerberos
klist  # Doit afficher un ticket valide

# Si pas de ticket, obtenir un ticket Kerberos
kinit administrator@VERTEX.LOCAL

# VÃ©rifier Ã  nouveau
klist

# Tester la connexion WinRM manuellement
ansible windows_clients -m win_ping -vvv

# Si Ã©chec, vÃ©rifier WinRM sur le client Windows (en PowerShell sur le client)
Enable-PSRemoting -Force
Set-Item WSMan:\localhost\Service\Auth\Kerberos -Value $true
Restart-Service WinRM
```

### Logs et debug

**Active Directory**
```powershell
# Logs Kerberos (Event ID 4768 = TGT request, 4769 = Service ticket request)
Get-WinEvent -LogName Security -FilterXPath "*[System[(EventID=4768 or EventID=4769)]]" | Select-Object -First 20 | Format-Table TimeCreated, Message -AutoSize

# Logs de rÃ©plication AD
repadmin /showrepl
```

**GLPI**
```bash
# Logs Apache
sudo tail -f /var/log/apache2/glpi_error.log

# Logs applicatifs GLPI
sudo tail -f /var/www/html/glpi/files/_log/php-errors.log

# Logs de synchronisation LDAP (via interface web)
# Configuration > Authentification > Annuaire LDAP > [Nom de l'annuaire] > Tester la connexion
```

**Ansible**
```bash
# Mode debug complet
export ANSIBLE_DEBUG=1
ansible-playbook playbook.yml -vvvv

# Logs de Kerberos cÃ´tÃ© client
sudo tail -f /var/log/krb5libs.log  # Si configurÃ©
```

---

## ğŸ“ Notes

**Points d'amÃ©lioration possibles :**
- DÃ©ployer un second contrÃ´leur de domaine (DC-02) pour la haute disponibilitÃ©
- ImplÃ©menter la segmentation VLAN (VLAN management, VLAN utilisateurs, DMZ pour GLPI)
- IntÃ©grer un SIEM (Wazuh, Splunk) pour le monitoring des logs AD et dÃ©tection d'anomalies
- Automatiser la sauvegarde des GPO et de la configuration AD via scripts
- CrÃ©er des playbooks Ansible pour le patch management automatisÃ© (Windows Update + apt upgrade)

**Ressources utiles :**
- [Documentation Microsoft AD DS](https://learn.microsoft.com/windows-server/identity/ad-ds/)
- [GLPI Documentation](https://glpi-install.readthedocs.io/)
- [Ansible Windows Guide](https://docs.ansible.com/ansible/latest/os_guide/windows_usage.html)
- [Kerberos MIT Documentation](https://web.mit.edu/kerberos/krb5-latest/doc/)
- [AGDLP Best Practices](https://learn.microsoft.com/windows-server/identity/ad-ds/plan/security-best-practices/implementing-least-privilege-administrative-models)

**Homelab context :**
- Ce projet s'intÃ¨gre dans un environnement Proxmox plus large avec pfSense (routage/firewall) et NAS Synology (stockage)
- Les VMs sont sauvegardÃ©es quotidiennement via Proxmox Backup Server
- Ã€ terme : segmentation rÃ©seau avec VLANs dÃ©diÃ©s pour chaque service (Management, Production, DMZ)

---

## ğŸ“„ Licence

Projet personnel Ã  but pÃ©dagogique - Libre de rÃ©utilisation et modification

---

