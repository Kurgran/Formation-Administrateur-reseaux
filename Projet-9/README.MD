# Backup Rsync + SSH â€” Solution de sauvegarde incrÃ©mentale & diffÃ©rentielle

**Description courte** : Mise en place d'une solution de sauvegarde automatisÃ©e via rsync over SSH, avec deux stratÃ©gies complÃ©mentaires (incrÃ©mentale et diffÃ©rentielle), sur infrastructure virtualisÃ©e Proxmox.

**Contexte homelab** : DÃ©ployÃ© sur Proxmox â€” deux VMs Debian 12 Server en rÃ©seau local isolÃ©.

**Date** : Janvier 2026

---

## ğŸ“‹ Vue d'ensemble

Ce projet R&D rÃ©pond Ã  un besoin concret de rÃ©silience informatique : remplacer une solution de sauvegarde devenue incompatible avec une infrastructure virtualisÃ©e. Deux stratÃ©gies distinctes ont Ã©tÃ© testÃ©es et implÃ©mentÃ©es : une sauvegarde incrÃ©mentale des contextes mÃ©tier (donnÃ©es applicatives), et une sauvegarde diffÃ©rentielle des machines virtuelles complÃ¨tes. L'ensemble est automatisÃ© via crontab et intÃ©gralement tracÃ© via des fichiers de log horodatÃ©s.

**Composants principaux :**
- **VM Client (simulation)** : HÃ©berge les donnÃ©es sources simulant les contextes mÃ©tier et les fichiers volumieux reprÃ©sentant des VMs
- **VM Serveur de stockage** : ReÃ§oit toutes les sauvegardes, organisÃ©es par contexte et par stratÃ©gie
- **Scripts Bash** : 7 scripts couvrant sauvegardes complÃ¨tes, incrÃ©mentales, diffÃ©rentielles et leurs restaurations respectives

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        SSH + rsync         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     VM CLIENT (simulation)  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   VM SERVEUR DE STOCKAGE     â”‚
â”‚       10.0.50.20            â”‚    Authentification         â”‚       10.0.50.10             â”‚
â”‚                             â”‚    par clÃ© asymÃ©trique      â”‚                              â”‚
â”‚  /home/sysadmin/            â”‚                             â”‚  /home/rsync_user/           â”‚
â”‚  â”œâ”€â”€ SITE/                  â”‚                             â”‚  â”œâ”€â”€ SITE/                   â”‚
â”‚  â”œâ”€â”€ RH/                    â”‚                             â”‚  â”‚   â”œâ”€â”€ complete/            â”‚
â”‚  â”œâ”€â”€ TICKETS/               â”‚                             â”‚  â”‚   â””â”€â”€ incremental/         â”‚
â”‚  â”œâ”€â”€ FICHIERS/              â”‚                             â”‚  â”œâ”€â”€ RH/                     â”‚
â”‚  â”œâ”€â”€ MAILS/                 â”‚                             â”‚  â”œâ”€â”€ TICKETS/                â”‚
â”‚  â””â”€â”€ VM_IMAGES/             â”‚                             â”‚  â”œâ”€â”€ FICHIERS/               â”‚
â”‚      (fichiers lourds)      â”‚                             â”‚  â”œâ”€â”€ MAILS/                  â”‚
â”‚                             â”‚                             â”‚  â””â”€â”€ MACHINES/               â”‚
â”‚  /home/sysadmin/logs_backup/â”‚                             â”‚      (sauvegarde diffÃ©rent.) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Proxmox Hypervisor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              (rÃ©seau interne isolÃ©)
```

**Cycle de sauvegarde StratÃ©gie 1 (donnÃ©es mÃ©tier) :**
```
Dimanche  â†’ Sauvegarde COMPLÃˆTE (rÃ©fÃ©rence hebdomadaire)
Lu â†’ Sa   â†’ Sauvegardes INCRÃ‰MENTALES (delta depuis la derniÃ¨re sauvegarde)
            Chaque incrÃ©mentale utilise --link-dest pour les hard links
            RÃ©tention : 7 sauvegardes conservÃ©es
```

**Cycle de sauvegarde StratÃ©gie 2 (VMs complÃ¨tes) :**
```
Dimanche  â†’ Sauvegarde COMPLÃˆTE (rÃ©fÃ©rence)
Lu â†’ Sa   â†’ Sauvegardes DIFFÃ‰RENTIELLES (delta depuis la rÃ©fÃ©rence du dimanche)
            La rÃ©fÃ©rence est toujours la sauvegarde complÃ¨te du dimanche
```

**Infrastructure :**
- **Plateforme** : Proxmox VE â€” 2 VMs Debian 12 Server (minimal, sans GUI)
- **Ressources** : 2 vCPU / 2 Go RAM / 100 Go disque dynamique chacune
- **RÃ©seau** : RÃ©seau interne Proxmox isolÃ© â€” `10.0.50.0/24`
- **Stockage** : Volumes locaux Proxmox (format qcow2)

---

## âš™ï¸ PrÃ©requis

**Versions testÃ©es :**
- rsync : 3.2.7
- OpenSSH : 9.2p1
- OS : Debian 12 (Bookworm) â€” installation minimale

**DÃ©pendances :**
```bash
# Sur la VM client
sudo apt update && sudo apt install -y rsync openssh-client

# Sur la VM serveur
sudo apt update && sudo apt install -y rsync openssh-server
```

**AccÃ¨s rÃ©seau requis :**
- Port `22` (SSH) : Communication rsync entre client et serveur

---

## ğŸš€ Installation

### Ã‰tape 1 : CrÃ©er l'utilisateur dÃ©diÃ© sur le serveur de stockage

```bash
# Sur le serveur (10.0.50.10)
sudo useradd -m -s /bin/bash rsync_user
sudo passwd rsync_user

# CrÃ©er l'arborescence de destination
sudo -u rsync_user mkdir -p /home/rsync_user/{SITE,RH,TICKETS,FICHIERS,MAILS}/{complete,incremental}
sudo -u rsync_user mkdir -p /home/rsync_user/MACHINES
```

**Explication** : On crÃ©e un compte non-root dÃ©diÃ© aux opÃ©rations de sauvegarde. Le principe du moindre privilÃ¨ge s'applique ici : rsync n'a besoin que d'accÃ©der Ã  son rÃ©pertoire de stockage, pas aux ressources systÃ¨me.

### Ã‰tape 2 : Configurer l'authentification SSH par clÃ© asymÃ©trique

```bash
# Sur la VM client (10.0.50.20) â€” gÃ©nÃ©rer la paire de clÃ©s
ssh-keygen -t ed25519 -C "backup_rsync_key" -f ~/.ssh/backup_key

# Copier la clÃ© publique sur le serveur
ssh-copy-id -i ~/.ssh/backup_key.pub rsync_user@10.0.50.10

# Tester la connexion sans mot de passe
ssh -i ~/.ssh/backup_key rsync_user@10.0.50.10
```

**Points d'attention :**
- Utiliser `ed25519` plutÃ´t que RSA 2048 : plus court, plus sÃ©curisÃ©, recommandÃ© en 2024+
- La clÃ© privÃ©e reste sur le client â€” **ne jamais la copier ailleurs**
- VÃ©rifier les permissions : `chmod 600 ~/.ssh/backup_key`

### Ã‰tape 3 : DÃ©ployer les scripts de sauvegarde

```bash
# Sur la VM client
git clone https://github.com/<votre-username>/backup-rsync-ssh.git
cd backup-rsync-ssh/scripts
chmod +x *.sh
```

**Adapter les variables de configuration** dans chaque script :
```bash
# Variables Ã  modifier selon votre environnement
BACKUP_SERVER="10.0.50.10"       # IP du serveur de stockage
BACKUP_USER="rsync_user"          # Utilisateur SSH dÃ©diÃ©
SSH_KEY="~/.ssh/backup_key"       # Chemin vers la clÃ© privÃ©e SSH
RETENTION=7                        # Nombre de sauvegardes Ã  conserver
```

### Ã‰tape 4 : Configurer la planification cron

```bash
# Ã‰diter la crontab de l'utilisateur courant
crontab -e
```

```bash
# Contenu de la crontab
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0-59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ heure (0-23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ jour du mois (1-31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ mois (1-12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ jour de la semaine (0=dimanche)
# â”‚ â”‚ â”‚ â”‚ â”‚

# StratÃ©gie 1 â€” Sauvegarde complÃ¨te (dimanche Ã  2h00)
0 2 * * 0 /home/sysadmin/scripts/backup_complete_s1.sh >> /home/sysadmin/logs_backup/cron_s1.log 2>&1

# StratÃ©gie 1 â€” Sauvegarde incrÃ©mentale (lundi-samedi Ã  2h00)
0 2 * * 1-6 /home/sysadmin/scripts/backup_incremental_s1.sh >> /home/sysadmin/logs_backup/cron_s1.log 2>&1

# StratÃ©gie 2 â€” Sauvegarde complÃ¨te VMs (dimanche Ã  3h00)
0 3 * * 0 /home/sysadmin/scripts/backup_complete_s2.sh >> /home/sysadmin/logs_backup/cron_s2.log 2>&1

# StratÃ©gie 2 â€” Sauvegarde diffÃ©rentielle VMs (lundi-samedi Ã  3h00)
0 3 * * 1-6 /home/sysadmin/scripts/backup_differential_s2.sh >> /home/sysadmin/logs_backup/cron_s2.log 2>&1
```

---

## ğŸ”§ Configuration

### Options rsync utilisÃ©es

**StratÃ©gie 1 â€” IncrÃ©mentale avec hard links (`--link-dest`)**
```bash
rsync -avz --delete \
  --link-dest="/home/rsync_user/SITE/incremental/latest" \
  -e "ssh -i ~/.ssh/backup_key -o StrictHostKeyChecking=no" \
  /home/sysadmin/SITE/ \
  rsync_user@10.0.50.10:/home/rsync_user/SITE/incremental/$(date +%Y%m%d_%H%M%S)/
```

| Option | RÃ´le |
|---|---|
| `-a` | Mode archive : prÃ©serve permissions, timestamps, liens symboliques, owner |
| `-v` | Verbose : affiche les fichiers transfÃ©rÃ©s (pour les logs) |
| `-z` | Compression des donnÃ©es en transit |
| `--delete` | Supprime sur la destination les fichiers supprimÃ©s Ã  la source |
| `--link-dest` | CrÃ©e des hard links vers les fichiers inchangÃ©s (Ã©conomie d'espace majeure) |
| `-e "ssh -i ..."` | SpÃ©cifie la commande SSH avec la clÃ© dÃ©diÃ©e |

**StratÃ©gie 2 â€” DiffÃ©rentielle (rÃ©fÃ©rence fixe du dimanche)**
```bash
rsync -avz --delete \
  --link-dest="/home/rsync_user/MACHINES/complete_reference" \
  -e "ssh -i ~/.ssh/backup_key" \
  /home/sysadmin/VM_IMAGES/ \
  rsync_user@10.0.50.10:/home/rsync_user/MACHINES/differential/$(date +%Y%m%d_%H%M%S)/
```

### Variables d'environnement des scripts

| Variable | Valeur exemple | Description |
|---|---|---|
| `BACKUP_SERVER` | `10.0.50.10` | IP du serveur de stockage |
| `BACKUP_USER` | `rsync_user` | Utilisateur SSH dÃ©diÃ© |
| `SSH_KEY` | `~/.ssh/backup_key` | ClÃ© privÃ©e pour l'authentification |
| `LOG_DIR` | `/home/sysadmin/logs_backup` | RÃ©pertoire des fichiers de log |
| `RETENTION` | `7` | Nombre de sauvegardes incrÃ©mentales Ã  conserver |
| `DATE` | `$(date +%Y%m%d_%H%M%S)` | Horodatage pour nommage des rÃ©pertoires |

---

## ğŸ“Š Utilisation

### Lancer une sauvegarde manuellement

```bash
# Sauvegarde complÃ¨te StratÃ©gie 1 (donnÃ©es mÃ©tier)
bash /home/sysadmin/scripts/backup_complete_s1.sh

# Sauvegarde incrÃ©mentale StratÃ©gie 1
bash /home/sysadmin/scripts/backup_incremental_s1.sh

# Sauvegarde diffÃ©rentielle StratÃ©gie 2 (VMs)
bash /home/sysadmin/scripts/backup_differential_s2.sh
```

### Consulter les logs

```bash
# Derniers logs de sauvegarde incrÃ©mentale
ls -lt /home/sysadmin/logs_backup/ | head -10

# Lire un fichier de log spÃ©cifique
cat /home/sysadmin/logs_backup/backup_incremental_20260115_020001.log

# Suivre les logs en temps rÃ©el lors d'une sauvegarde
tail -f /home/sysadmin/logs_backup/cron_s1.log
```

### Lancer une restauration

```bash
# Restauration incrÃ©mentale â€” choisir la version Ã  restaurer
bash /home/sysadmin/scripts/restore_incremental_s1.sh 20260115_020001

# Restauration diffÃ©rentielle VM
bash /home/sysadmin/scripts/restore_differential_s2.sh 20260115_030001
```

### VÃ©rifier l'espace disque Ã©conomisÃ© par les hard links

```bash
# Sur le serveur de stockage
du -sh /home/rsync_user/SITE/incremental/*/
df -h /home/rsync_user/
```

---

## ğŸ› Troubleshooting

### Erreur : `Permission denied (publickey)`
**Cause** : La clÃ© publique n'est pas correctement dÃ©ployÃ©e sur le serveur, ou les permissions du rÃ©pertoire `.ssh` sont incorrectes.
**Solution** :
```bash
# VÃ©rifier les permissions sur le serveur
chmod 700 /home/rsync_user/.ssh
chmod 600 /home/rsync_user/.ssh/authorized_keys

# Re-dÃ©ployer la clÃ© publique
ssh-copy-id -i ~/.ssh/backup_key.pub rsync_user@10.0.50.10
```

### Erreur : `rsync: command not found`
**Cause** : rsync non installÃ© sur l'une des deux machines.
**Solution** :
```bash
sudo apt install -y rsync
which rsync   # Doit retourner /usr/bin/rsync
```

### Erreur : `ssh: Could not resolve hostname`
**Cause** : ProblÃ¨me DNS ou rÃ©solution de nom sur le rÃ©seau interne Proxmox.
**Solution** :
```bash
# Utiliser l'IP directement plutÃ´t que le hostname
# Ou ajouter une entrÃ©e dans /etc/hosts
echo "10.0.50.10  backup-server" | sudo tee -a /etc/hosts
```

### La rÃ©tention ne s'applique pas (accumulation de sauvegardes)
**Cause** : La fonction de suppression dans le script ne compte pas correctement les sauvegardes.
**Solution** :
```bash
# VÃ©rifier le nombre de rÃ©pertoires prÃ©sents
ls /home/rsync_user/SITE/incremental/ | wc -l

# Tester la logique de suppression manuellement
ls -t /home/rsync_user/SITE/incremental/ | tail -n +8
```

### Logs et debug

```bash
# Lancer rsync en mode verbose + dry-run (simulation sans modification)
rsync -avz --dry-run --stats \
  -e "ssh -i ~/.ssh/backup_key" \
  /home/sysadmin/SITE/ \
  rsync_user@10.0.50.10:/home/rsync_user/SITE/complete/

# Codes de retour rsync courants
# 0 = SuccÃ¨s
# 23 = Transfert partiel (certains fichiers ignorÃ©s)
# 24 = Fichiers disparus pendant le transfert (normal si fichiers temporaires)
echo "Code de retour : $?"
```

---

## ğŸ“ Notes

**Points d'amÃ©lioration possibles :**
- Notifications par email en cas d'Ã©chec de sauvegarde (msmtp ou ssmtp)
- Monitoring de l'espace disque avec alerte seuil (script dÃ©diÃ© ou intÃ©gration Zabbix/Wazuh)
- Chiffrement GPG des sauvegardes avant transfert (conformitÃ© donnÃ©es sensibles)
- Sauvegarde dÃ©portÃ©e vers NAS ou stockage distant (offsite backup)
- Tests de restauration automatiques pÃ©riodiques avec vÃ©rification d'intÃ©gritÃ© (sha256sum)
- Rotation et compression des fichiers de log (logrotate)

**Ressources utiles :**
- [Documentation officielle rsync](https://rsync.samba.org/documentation.html)
- [Man page rsync](https://linux.die.net/man/1/rsync)
- [IT-Connect â€” Sauvegarde incrÃ©mentale vs diffÃ©rentielle](https://www.it-connect.fr)

**Homelab context :**
- Infrastructure Proxmox â€” rÃ©seau interne isolÃ© (pas de routage externe nÃ©cessaire)
- SSH configurÃ© en Ã©coute sur le port 22 standard dans cet environnement de lab (recommandation prod : port non standard + fail2ban)
- Scripts testÃ©s sur Debian 12 â€” compatibles Ubuntu 22.04+

---

## ğŸ“„ Licence

MIT â€” Libre utilisation, modification et redistribution avec attribution.

